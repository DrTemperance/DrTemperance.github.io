<html lang='en'>

<head>
	<meta charset='UTF-8'/>
	<title> Time Rift Prototype | 1980s </title>
	<link href='riftStylePrototype.css' rel='stylesheet'/>
	<script async src='kekePalmer.js'></script>
	<script async src='stories!/80s/scripting/playerscripting.js'></script>
	<script async src='stories!/80s/scripting/data.js'></script>
	<link href='https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,500,1,0' rel='stylesheet'/>
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport'/>
</head>

<body class='80sMode'>

<audio autoplay>
	<source src='stories!/80s/flopica.mp3' type='audio/mpeg'/>
</audio>
<audio autoplay loop>
	<source src='stories!/80s/tropica.wav' type='audio/wav'/>
</audio>

<div id='custom-cursor' style='display: none;'>
</div>
<div class='column reversed' id='content'>
	<img alt='Scanlines' id='scanlines' src='stories!/80s/crtscanlines.gif'/>
	<div id='console-log'></div>
	<div class='column reversed inputParent'>
		<div class='row'>
			<span id='prompt'>>_</span>
			<input autocomplete='off' id='terminal' maxlength='88' spellcheck='false'/>
			<span class='material-symbols-outlined' id='configButton'>more_vert</span>
		</div>
	</div>
	<button style='border: none;position: fixed; left:1161px;top: 696px;width: 50px;height: 30px;cursor: pointer; background: none;'
	></button>
	<span style='font-size: 1%; position: absolute; left: 56.5%; top: 78%; width: 100%; height: 100%; background: none; filter: drop-shadow(0 0 7px lime) blur(2px);'>*</span>
</div>
<dialog class='row' id='configMenu'>
	<aside class='columns' style='float: left;'>
		<button id='settingsOption' onclick='cycleSettings(0)'>
			Advanced User<br/><sub>Currently: <span id='auStatus'>...</span></sub>
		</button>
		<button id='settingsOption' onclick='cycleSettings(1)'>
			Graphics Settings<br/><sub>Currently: <span id='gStatus'>...</span></sub>
		</button>
	</aside>
	<aside class='columns' style='float: right;'>
		<button id='settingsOption' onclick='cycleSettings(3)'>unset 1<br/><sub>Currently: <span
				id='u1Status'>...</span></sub></button>
		<button id='settingsOption' onclick='cycleSettings(4)'>unset 2<br/><sub>Currently: <span
				id='u2Status'>...</span></sub></button>
	</aside>
	<span id='configClose' onclick="closeMenu('configClose')">Close Menu</span>
</dialog>

</body>

</html>

<script async>
  document.getElementById('configButton')
			 .addEventListener('click',() => {document.getElementById('configMenu').style.visibility = 'visible'});

  async function closeMenu(e) {document.getElementById(e).parentElement.style.visibility = 'hidden'}

  let config = {
	 custom   : {
		settings: [
		  {
			 name    : 'AdvancedUser',
			 status  : false,
			 possible: [false,true],
		  },
		  {
			 name    : 'null1',
			 status  : null,
			 possible: [`null`,`null`],
		  },
		  {
			 name    : 'null2',
			 status  : null,
			 possible: [`null`,`null`],
		  },
		  {
			 name    : 'null3',
			 status  : null,
			 possible: [`null`,`null`],
		  },
		],
	 },
	 constants: {
		era          : `unset`,
		currentPrompt: `>`,
		prompt       : {'2000s': `$`,'1990s': `C:/`,'1980s': `>`,'unset': '>_'},
	 },
  };

  async function setEra(eraChoice) {
	 config.constants.era = eraChoice ? eraChoice : 'unset';
	 config.constants.currentPrompt = prompt[eraChoice];
  }
</script>

<script async>
  const customCursor = document.getElementById('custom-cursor');

  document.addEventListener('DOMContentLoaded',() =>
	  document.addEventListener('mousemove',e => {
		 const {bottom,left,right,top} = document.getElementById('console-log').getBoundingClientRect();

		 e.clientX>=left && e.clientX<=right && e.clientY>=top && e.clientY<=bottom
		 ? (document.body.style.cursor = 'none', customCursor.style.display = 'block', customCursor.style.left
			 = `${e.pageX}px`, customCursor.style.top = `${e.pageY}px`)
		 : (document.body.style.cursor = 'auto', customCursor.style.display = 'none')
	  }));

  // Terminal functionality //
  const terminalElement = document.getElementById('terminal'),
		  consoleLog      = document.getElementById('console-log'),
		  commandHistory  = [];

  let commandIndex = -1;

  terminalElement.addEventListener('keydown',({key,preventDefault}) => {
	 preventDefault();
	 if (key==='Enter' && terminalElement.value.trim()!=='') {
		preventDefault();
		commandHistory.unshift(terminalElement.value), inputHandler(convertToFunctionCall(terminalElement.value));
		terminalElement.value = '';
		commandIndex = -1;
	 }
	 if (key==='ArrowUp' && commandIndex!==commandHistory.length - 1) {
		commandIndex++, terminalElement.value = commandHistory[commandIndex];
	 }
	 if (key==='ArrowDown') {
		commandIndex===0 && (commandIndex--, terminalElement.value = '');
		commandIndex!== -1 && (commandIndex--, terminalElement.value = commandHistory[commandIndex]);
	 }
  });

  async function inputHandler(rawInput) {
	 try {
		const result = eval(rawInput);
		await addToConsole(rawInput,JSON.stringify(result));
	 } catch (e) {await addToConsole(rawInput,e)}
  }

  const addToHistory = i => {
	 commandHistory.unshift(i);
	 commandIndex = -1;
	 commandHistory.length>=30 && commandHistory.pop();
  };

  async function addToConsole(command,result) {
	 const li1 = document.createElement('li');
	 li1.textContent = `${config.constants.currentPrompt} ${command} <br><br> ${result}`;
	 consoleLog.appendChild(li1);
  }

  function convertToFunctionCall({toLowerCase}) {
	 let index,argument,functionName;
	 const lowerInput = toLowerCase();

	 switch (!0) {
		case lowerInput.includes('go'):
		  index = lowerInput.indexOf(' to');
		  if (index=== -1) {return `${lowerInput}`} else {
			 functionName = lowerInput.substring(0,index);
			 argument = lowerInput.substring(index + 4).replace(/ /g,'');
			 return `${functionName}('${argument}')`;
		  }
		case lowerInput.includes('inspect') || lowerInput.includes('enter'):
		  index = lowerInput.indexOf(' ');
		  if (index=== -1) {return `${lowerInput}`} else {
			 functionName = lowerInput.substring(0,index);
			 argument = lowerInput.substring(index).replace(/ /g,'');
			 return `${functionName}(${argument})`;
		  }
		default:
		  return `${lowerInput}`;
	 }
  }
</script>