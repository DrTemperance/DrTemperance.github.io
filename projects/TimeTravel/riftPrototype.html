<html lang='en'>
<head>
	<meta charset='UTF-8' />
	<title> Time Rift | Prototype </title>
	<link href='riftStylePrototype.css' rel='stylesheet' />
	<script async src='stories!/80s/scripting/playerscripting.js'></script>
	<script async src='stories!/80s/scripting/data.js'></script>
	<link href='https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,500,1,0' rel='stylesheet' />
	<meta content='width=device-width, height=device-height, initial-scale=1' name='viewport' />
</head>

<audio id='80sKeyPress' src='./stories!/80s/audio/keypress.mp3' preload='auto'></audio>

<body class='80sMode'>

<div id='custom-cursor' style='display: none;'>
</div>
<div class='column reversed' id='content'>
	<img class='80sAssets' id='scanlines' src='stories!/80s/crtscanlines.gif' />
	<div id='console-log'></div>
	<div class='column reversed inputParent'>
		<div class='row'>
			<span id='prompt'>>_</span>
			<input alt='terminal input' autocomplete='off' id='terminal' maxlength='90' spellcheck='false' type='text' value='' />
			<span class='material-symbols-outlined' id='configButton'>more_vert</span>
		</div>
	</div>
	<button style='border: none;position: fixed; left:1161px;top: 696px;width: 50px;height: 30px;cursor: pointer; background: none;'
	></button>
	<span style='font-size: 1%; position: absolute; left: 56.5%; top: 78%; width: 100%; height: 100%; background: none; filter: drop-shadow(0 0 7px lime) blur(2px);'>*</span>
</div>
<dialog class='row' id='configMenu'>
	<aside class='columns' style='float: left;'>
		<button id='settingsOption' onclick='cycleSettings(0)'>
			Advanced User<br /><sub>Currently: <span id='auStatus'>...</span></sub>
		</button>
		<button id='settingsOption' onclick='cycleSettings(1)'>
			Graphics Settings<br /><sub>Currently: <span id='gStatus'>...</span></sub>
		</button>
	</aside>
	<aside class='columns' style='float: right;'>
		<button id='settingsOption' onclick='cycleSettings(3)'>unset 1<br /><sub>Currently: <span
						id='u1Status'>...</span></sub></button>
		<button id='settingsOption' onclick='cycleSettings(4)'>unset 2<br /><sub>Currently: <span
						id='u2Status'>...</span></sub></button>
	</aside>
	<span id='configClose' onclick="closeMenu('configClose')">Close Menu</span>
</dialog>

</body>
</html>

<script>
	let config = {
		custom   : {
			settings: [
				{
					name    : 'AdvancedUser',
					tooltip : 'Classic Terminal Experience',
					status  : false,
					possible: [false, true]
				},
				{
					name    : 'null1',
					tooltip : 'null1',
					status  : 'null1',
					possible: [`null1`, `null2`]
				},
				{
					name    : 'null2',
					tooltip : 'null2',
					status  : 'null1',
					possible: [`null1`, `null2`]
				},
				{
					name    : 'null3',
					tooltip : 'null3',
					status  : 'null1',
					possible: [`null1`, `null2`]
				}
			]
		},
		constants: {
			era          : `unset`,
			currentPrompt: `>`,
			prompt       : { '2000s': `$`, '1990s': `C:/`, '1980s': `>`, 'unset': '>_' }
		}
	};

	document.getElementById('configButton')
	        .addEventListener('click', () => {document.getElementById('configMenu').style.visibility = 'visible'});

	async function closeMenu(e) {document.getElementById(e).parentElement.style.visibility = 'hidden'}

	let
					Player        = {
						Command: {
							Index  : -1,
							History: []
						}
					},
					TerminalInput = document.getElementById('terminal'),
					PsuedoConsole = document.getElementById('console-log'),
					commandIndex  = -1,
					{ style }     = document.getElementById('custom-cursor');

	document.addEventListener('DOMContentLoaded', async () =>
					document.addEventListener('mousemove', ({ clientX, clientY, pageX, pageY }) => {
						let { bottom, left, right, top } = PsuedoConsole.getBoundingClientRect();

						clientX>=left && clientX<=right && clientY>=top && clientY<=bottom
						? (document.body.style.cursor = 'none',
										style.display = 'block',
										style.left = `${pageX}px`,
										style.top = `${pageY}px`)
						: (document.body.style.cursor = 'auto',
										style.display = 'none');
					}));

	// Terminal functionality //
	TerminalInput.addEventListener('keydown', async e => {
		switch (e.key) {
			case 'Enter':
				e.preventDefault();
				if (TerminalInput.value.trim()==='') {
					new Audio('./stories!/80s/audio/error.mp3').play();
				} else {
					AddToHistory(TerminalInput.value);
					InputHandler(convertToFunctionCall(TerminalInput.value));
					TerminalInput.value = '';
				}
				break;
			case 'ArrowUp':
				e.preventDefault();
				commandIndex = commandIndex===Player.Command.History.length - 1 ? commandIndex : commandIndex + 1;
				TerminalInput.value = Player.Command.History[commandIndex];
				break;
			case 'ArrowDown':
				e.preventDefault();
				commandIndex===0 && (commandIndex--, TerminalInput.value = '');
				commandIndex!== -1 && (commandIndex--, TerminalInput.value = Player.Command.History[commandIndex]);
				break;
			default:
				document.getElementById('80sKeyPress').isActive;
				break;
		}
	});

	async function InputHandler(RawInput) {
		await console.log(`inputHandler: ${RawInput}`);
		try {
			const Result = await eval(RawInput);
			AddToConsole(RawInput, JSON.stringify(Result));
		} catch (er) {AddToConsole(RawInput, er.toString())}
	}

	async function AddToHistory(In) {
		Player.Command.History.unshift(In);
		commandIndex = -1;
		Player.Command.History.length>=30 && Player.Command.History.pop();
	}

	function AddToConsole(command, result) {
		let rev = document.createElement('li');
		rev.innerHTML = `${config.constants.currentPrompt} ${command} <br><br> ${result}`;
		PsuedoConsole.appendChild(rev);
		PsuedoConsole.scrollTop = PsuedoConsole.scrollHeight;
	}

	function convertToFunctionCall(input) {
		let index, argument, functionName, lowerInput = input.toLowerCase();
		console.log(input);
		switch (true) {
			case lowerInput.includes('go'):
				index = lowerInput.indexOf(' to');
				if (index=== -1) return `${lowerInput}`;
				functionName = lowerInput.substring(0, index);
				argument = lowerInput.substring(index + 4).replace(/ /g, '');
				return `${functionName}('${argument}')`;
			case lowerInput.includes('inspect') || lowerInput.includes('enter'):
				index = lowerInput.indexOf(' ');
				if (index=== -1) return `${lowerInput}`;
				functionName = lowerInput.substring(0, index);
				argument = lowerInput.substring(index).replace(/ /g, '');
				return `${functionName}(${argument})`;
			default:
				return `${lowerInput}`;
		}
	}
</script>